<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœè»Šå ´æ¯”åƒ¹ç¶²</title>
    <link rel="stylesheet" href="./main.css">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.13.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.13.0/mapbox-gl.css" rel="stylesheet" />
</head>
<body>
    <!-- å®šä½æ¬Šé™è«‹æ±‚é®ç½©å±¤ (é è¨­éš±è—) -->
    <div id="location-overlay">
        <div class="overlay-content">
            <h2>éœ€è¦æ‚¨çš„ä½ç½®æ¬Šé™</h2>
            <p>ç‚ºäº†æä¾›åœè»Šå ´è³‡è¨Šï¼Œæœ¬ç¶²ç«™éœ€è¦å–å¾—æ‚¨ç›®å‰çš„ä½ç½®ã€‚è«‹å…è¨±æˆ‘å€‘å­˜å–æ‚¨çš„ä½ç½®è³‡è¨Šã€‚</p>
            <button id="retry-location-btn">é‡è©¦</button>
        </div>
    </div>

    <!-- å·¦å´æ»‘å‹•ç¯©é¸æ¬„ -->
    <div id="filter-sidenav" class="sidenav">
        <div class="condition-toggle-group">
            <label id="condition-toggle-label" style="cursor:pointer;">ç¯©é¸æ¢ä»¶</label>
            <button id="condition-toggle-btn" class="triangle-btn" type="button" aria-label="å±•é–‹æ¢ä»¶"></button>
        </div>
        <div id="condition-checkbox-group">
            <div class="checkbox-row">
                <label><input type="checkbox"> å®¤å…§åœè»Šå ´</label>
                <label><istenenput type="checkbox"> é›»å‹•è»Šå……é›»</label>
            </div>
            <input type="text" id="price-input" placeholder="åƒ¹æ ¼ä¸Šé™(å…ƒ/h)ï¼Œä¾‹å¦‚: 50">
        </div>
        <div class="range-toggle-group">
            <label for="range-select" id="range-toggle-label" style="cursor:pointer;">æœå°‹ç¯„åœ</label>
            <button id="range-toggle-btn" class="triangle-btn" type="button" aria-label="å±•é–‹æœå°‹ç¯„åœ"></button>
        </div>
        <div id="range-select-group" style="display: none;">
            <select id="range-select" onchange="updateRangePlaceholder()">
                <option value="count">æœ€è¿‘çš„____å€‹</option>
                <option value="distance">____å…¬å°ºä»¥å…§</option>
            </select>
            <input type="text" id="range-input" placeholder="10">
        </div>
        <!-- æ’åºå€å¡Šï¼šä¸‰è¡Œè·é›¢/åƒ¹æ ¼/å‰©é¤˜ç©ºä½ï¼Œæ¯è¡Œå³å´æœ‰ä¸Šä¸‹ç®­é ­ -->
        <div class="sort-list-group" style="width: calc(100% - 72px); margin-left: 32px; margin-bottom: 8px; display: flex; flex-direction: column; gap: 4px;">
            <div class="sort-row sort-second"><span class="sort-label">ğŸ“è·é›¢</span><span></span></div>
            <div class="sort-row sort-second"><span class="sort-label">ğŸ’²åƒ¹æ ¼</span><span></span></div>
            <div class="sort-row sort-second"><span class="sort-label">ğŸ…¿ï¸å‰©é¤˜ç©ºä½</span><span></span></div>
        </div>
        <script>
        function updateRangePlaceholder() {
            var select = document.getElementById('range-select');
            var input = document.getElementById('range-input');
            if (select.value === 'count') {
                input.placeholder = 'ä¾‹å¦‚ï¼š10';
            } else {
                input.placeholder = 'ä¾‹å¦‚ï¼š500';
            }
        }
        // å±•é–‹/æ”¶åˆæœå°‹ç¯„åœ
        document.addEventListener('DOMContentLoaded', function() {
            var btn = document.getElementById('range-toggle-btn');
            var group = document.getElementById('range-select-group');
            var label = document.getElementById('range-toggle-label');
            function toggleRange() {
                if (group.style.display === 'none') {
                    group.style.display = 'block';
                    btn.classList.add('open');
                } else {
                    group.style.display = 'none';
                    btn.classList.remove('open');
                }
            }
            btn.addEventListener('click', toggleRange);
            label.addEventListener('click', toggleRange);
            // æ¢ä»¶å±•é–‹/æ”¶åˆ
            var condBtn = document.getElementById('condition-toggle-btn');
            var condLabel = document.getElementById('condition-toggle-label');
            var condGroup = document.getElementById('condition-checkbox-group');
            function toggleCond() {
                if (condGroup.style.display === 'none' || condGroup.style.display === '') {
                    condGroup.style.display = 'block';
                    condBtn.classList.add('open');
                } else {
                    condGroup.style.display = 'none';
                    condBtn.classList.remove('open');
                }
            }
            condBtn.addEventListener('click', toggleCond);
            condLabel.addEventListener('click', toggleCond);

            // å‹•æ…‹æ¸²æŸ“æ’åºç®­é ­
            function renderSortArrows() {
                const sortList = document.querySelector('.sort-list-group');
                const rows = Array.from(sortList.querySelectorAll('.sort-row'));
                rows.forEach((row, idx) => {
                    const label = row.querySelector('.sort-label').textContent.trim();
                    const span = row.querySelector('span:last-child');
                    span.innerHTML = '';
                    // ä¸Šç®­é ­
                    if (idx > 0) {
                        const upBtn = document.createElement('button');
                        upBtn.className = 'sort-arrow sort-up';
                        upBtn.title = label + 'ä¸Šç§»';
                        upBtn.style = 'background:none; border:none; cursor:pointer; padding:2px 4px;';
                        upBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 16 16"><path d="M8 4l4 6H4z" fill="#818181"/></svg>';
                        upBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            const prev = row.previousElementSibling;
                            if (prev && prev.classList.contains('sort-row')) {
                                sortList.insertBefore(row, prev);
                                renderSortArrows();
                            }
                        });
                        span.appendChild(upBtn);
                    }
                    // ä¸‹ç®­é ­
                    if (idx < rows.length - 1) {
                        const downBtn = document.createElement('button');
                        downBtn.className = 'sort-arrow sort-down';
                        downBtn.title = label + 'ä¸‹ç§»';
                        downBtn.style = 'background:none; border:none; cursor:pointer; padding:2px 4px;';
                        downBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 16 16"><path d="M8 12l-4-6h8z" fill="#818181"/></svg>';
                        downBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            const next = row.nextElementSibling;
                            if (next && next.classList.contains('sort-row')) {
                                sortList.insertBefore(next, row);
                                renderSortArrows();
                            }
                        });
                        span.appendChild(downBtn);
                    }
                });
            }
            renderSortArrows();
        });
        </script>
        <!-- æ‰¾åˆ°çš„åœè»Šå ´å€å¡Šï¼Œç›´æ¥è·Ÿåœ¨ input ä¸‹æ–¹ -->
        <div id="parking-info-block">
            <h3 style="text-align:center; font-size:20px; color:#fff; margin-bottom:8px;">æ‰¾åˆ°çš„åœè»Šå ´</h3>
            <div id="info-content">
                <ul id="parking-list" style="background:rgba(255,255,255,0.95); color:#222; border-radius:8px; margin:0 16px; padding:8px 0;">
                    <li>åœè»Šå ´ A - 100å…¬å°º</li>
                    <li>åœè»Šå ´ B - 250å…¬å°º</li>
                    <li>åœè»Šå ´ C - 400å…¬å°º</li>
                    <li>åœè»Šå ´ D - 300å…¬å°º</li>
                    <li>åœè»Šå ´ E - 350å…¬å°º</li>
                    <li>åœè»Šå ´ F - 700å…¬å°º</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- é ‚éƒ¨æ¨™é¡Œæ¬„ï¼ŒåŒ…å«æŒ‰éˆ•å’Œç¶²ç«™æ¨™é¡Œ -->
    <div id="top-bar">
        <h1 id="main-title">åœè»Šå ´æ¯”åƒ¹ç¶²</h1>
    </div>

    <!-- ä¸»è¦å…§å®¹çš„åŒ…è£å®¹å™¨ï¼ŒåŒ…å«åœ°åœ–å’Œå³å´è³‡è¨Šæ¬„ -->
    <div id="content-wrapper">
        <!-- ä¸­é–“ä¸»è¦å…§å®¹å€åŸŸ -->
        <div id="main-content">
            <div id="map-container" style="position: relative;">
                <div id="map"></div>
                <button id="locate-btn" class="locate-btn" onclick="locateUser()" title="å®šä½æˆ‘">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="12" cy="12" r="8" stroke="#3498db" stroke-width="2" fill="#fff"/>
                      <circle cx="12" cy="12" r="3" fill="#3498db"/>
                    </svg>
                </button>
            </div>
            <script>
  mapboxgl.accessToken = 'pk.eyJ1IjoiY2FzcGVyMjEiLCJhIjoiY21jemluNnduMHQ5NTJrc2J6dGNoeG4zNCJ9.YOJYDPzvov3Q_SsxqjyR-A';

  let userLocation = null;
  let currentRouteId = null;
  let activePopup = null;
  let parking_list = [];  // å„²å­˜è·é›¢è³‡æ–™
  let parking_markers = [];  // å„²å­˜ marker å’Œåœè»Šå ´è³‡æ–™å°æ‡‰

  // åœ°åœ–åˆå§‹åŒ–
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/dark-v11',
    center: [121.5376, 25.0273],
    zoom: 13
  });

  window.addEventListener('click', (event) => {
    console.log(parking_list);stene
  });


  // è¼‰å…¥åœè»Šå ´ markerï¼Œä½†ä¸è¨ˆç®—è·é›¢
  fetch('parking_data.json')
    .then(response => response.json())
    .then(data => {
      data.forEach(point => {
        const marker = new mapboxgl.Marker({ color: '#e74c3c' })
          .setLngLat([point.lng, point.lat])
          .setPopup(new mapboxgl.Popup().setText(`${point.name}ï½œæ¯å°æ™‚${point.price_per_hour}å…ƒ`))
          .addTo(map);

        // æŠŠ marker å’Œå°æ‡‰åœè»Šå ´è³‡æ–™æ”¾é€²é™£åˆ—
        parking_markers.push({ marker: marker, data: point });

        // hover äº‹ä»¶ï¼ˆå…ˆåªé¡¯ç¤º popupï¼Œä¸ç•«è·¯ç·šï¼‰
        marker.getElement().addEventListener('mouseenter', () => {
          const parkingInfo = parking_list.find(p => p.name === point.name);
          if (parkingInfo && userLocation) {
            // å¦‚æœå·²è¨ˆç®—éè·é›¢ï¼Œå°±ç•«è·¯ç·šå’Œé¡¯ç¤º popup
            if (currentRouteId) {
              if (map.getSource(currentRouteId)) {
                map.removeLayer(currentRouteId);
                map.removeSource(currentRouteId);
              }
            }
            if (activePopup) activePopup.remove();

            currentRouteId = 'route-' + Date.now();
            map.addSource(currentRouteId, {
              type: 'geojson',
              data: { type: 'Feature', geometry: parkingInfo.route }
            });
            map.addLayer({
              id: currentRouteId,
              type: 'line',
              source: currentRouteId,
              layout: { 'line-cap': 'round', 'line-join': 'round' },
              paint: { 'line-color': '#3b9ddd', 'line-width': 4 }
            });

            const coords = parkingInfo.route.coordinates;
            const midPoint = coords[Math.floor(coords.length / 2)];

            activePopup = new mapboxgl.Popup({ closeButton: false, closeOnClick: false })
              .setLngLat(midPoint)
              .setHTML(`<strong>è·é›¢:</strong> ${parkingInfo.distance} km<br><strong>é ä¼°:</strong> ${parkingInfo.duration} åˆ†`)
              .addTo(map);
          }
        });

        marker.getElement().addEventListener('mouseleave', () => {
          if (currentRouteId) {
            if (map.getSource(currentRouteId)) {
              map.removeLayer(currentRouteId);
              map.removeSource(currentRouteId);
            }
            currentRouteId = null;
          }
          if (activePopup) {
            activePopup.remove();
            activePopup = null;
          }
        });
      });
    });

  // ä½¿ç”¨è€…å®šä½ï¼†è¨ˆç®—è·é›¢
  function locateUser() {
    navigator.geolocation.getCurrentPosition(position => {
      userLocation = [position.coords.longitude, position.coords.latitude];
      new mapboxgl.Marker({ color: '#3498db' })
        .setLngLat(userLocation)
        .setPopup(new mapboxgl.Popup().setText("ä½ çš„ä½ç½®"))
        .addTo(map);
      map.flyTo({ center: userLocation, zoom: 15 });

      // å®šä½å®Œæ‰å»è¨ˆç®—æ‰€æœ‰è·é›¢
      parking_markers.forEach(item => {
        const point = item.data;
        const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${userLocation[0]},${userLocation[1]};${point.lng},${point.lat}?geometries=geojson&access_token=${mapboxgl.accessToken}`;

        fetch(url)
          .then(res => res.json())
          .then(result => {
            const distanceKm = (result.routes[0].distance / 1000).toFixed(2);
            const durationMin = Math.round(result.routes[0].duration / 60);
            const route = result.routes[0].geometry;

            parking_list.push({
              ...point,
              distance: parseFloat(distanceKm),
              duration: durationMin,
              route: route
            });
          });
      });
    }, () => {
      alert("ç„¡æ³•å–å¾—æ‚¨çš„å®šä½ï¼Œè«‹ç¢ºèªå®šä½æ¬Šé™ã€‚");
    });
  }
  </script>
        </div>

        <!-- å³å´è³‡è¨Šæ¬„ï¼Œé¡¯ç¤ºæ‰¾åˆ°çš„åœè»Šå ´ -->
        <!-- (å·²ç§»è‡³å·¦å´sidenav) -->
    </div>

    <!-- å¼•å…¥ JavaScript æª”æ¡ˆ -->
    <script src="./main.js"></script>
</body>
</html>